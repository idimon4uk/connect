<!DOCTYPE html>
<html>
  <head>
    <title>TREZOR Sign Transaction Test</title>
    <script>

     function flipBytes(byte_array) {
         size = byte_array.length;
         if (size%2 == 1) {
             buffer = byte_array[size-1]
             byte_array = byte_array.substring(0,size-1)+'0'+buffer
             size = byte_array.length;
         }
         res = ''
         for (i=size-1;i>0;i-=2){
             res += byte_array.substring(i-1,i+1);
         }
         return res;
     }
     function trezorSignTx(testId) {
        // this example requires a device loaded with seed:
        // alcohol woman abuse must during monitor noble actual mixed trade anger aisle

        // for a convenience, TrezorConnect internals convert xpubs to HDNodeType.
        // Test:
        // https://github.com/trezor/python-trezor/blob/master/tests/device_tests/test_multisig.py
        var ext1 = 'xpub6E2LkiC2h7icfcjXPFDmwufDRaaTjTRYcS2nD7eGQeFx1WwZxxvCya5GefiJND6ddJnAjzzMusLcCnu6WyhZPrF6e5G71MWjNJVfs6u9csg';
        var ext2 = 'xpub6FKKCwdfD85eHmKn7d3mmbhqsHnGkB2n7Hmre29gbnR1cR4U1wrtf2akh1VVqjcTdfkxmwPjQyYPhLLgwBijfFPAYqTZzcjj4awB1BMUxq2';

        //changed
        var int1 = 'xpub6E681U8qj5mSgpu74PVFFvH7vZMM6GmkCoMkrhmNFGNj9uydN8tjGsC3DZYRjMEybJk2wBZtFaWvxpGyW7NUgCxwDNizZThjat47zEgjSZg';
        url = 'https://explorer.zensystem.io/insight-api-zen/'
        tx_request = 'tx/'
        block_request = 'blocks/';
        prev_index = 0
        tx_hash = '6b72d99239f092e9c0c0009d4e0efcf3db9a6b0e8d40fb72ca18c6b098ac1833';




        var xmlHttpTx = new XMLHttpRequest();
        xmlHttpTx.open( "GET", (url+tx_request+tx_hash), false ); // false for synchronous request
        xmlHttpTx.send( null );
        // console.log(JSON.parse(xmlHttpTx.responseText)['vout'][prev_index]['scriptPubKey']['hex']);
        prev_input_script = JSON.parse(xmlHttpTx.responseText)['vout'][prev_index]['scriptPubKey']['hex'];


        var xmlHttpBlock = new XMLHttpRequest();
        xmlHttpBlock.open( "GET", (url+block_request), false ); // false for synchronous request
        xmlHttpBlock.send( null );
        block = JSON.parse(xmlHttpBlock.responseText)['blocks'][199]
        block_hash = flipBytes(block['hash']);
        block_height = flipBytes(parseInt(block['height']).toString(16))
        console.log(block_hash,block_height)

        //spend a multisig input
        var inputs;
        if (testId == 1) {
            inputs = [
                {
                    address_n: [1],
                    prev_index: prev_index,
                    prev_hash: tx_hash,
                    script_type: 'SPENDMULTISIG',
                    multisig: {
                        pubkeys: [
                            {node: int1, address_n: [1]},
                            {node: int1, address_n: [2]},
                            {node: int1, address_n: [3]}
                        ],
                        signatures: ['', '', ''],
                        m: 2
                    }
                }
            ];
        } else {
            inputs = [
                {
                    address_n: [3],
                    prev_index: prev_index,
                    prev_hash: tx_hash,
                    script_type: 'SPENDMULTISIG',
                    multisig: {
                        pubkeys: [
                            {node: int1, address_n: [1]},
                            {node: int1, address_n: [2]},
                            {node: int1, address_n: [3]}
                        ],
                        signatures: ['3045022100985cc1ba316d140eb4b2d4028d8cd1c451f87bff8ff679858732e516ad04cd3402207af6edda99972af0baa7702a3b7448517c8242e7bca669f6861771cdd16ee058', '', ''],
                        m: 2
                    }
                }
            ];
        }
        
        // send to PAYTOADDRESS output
        var outputs = [{
            script_type: 'PAYTOADDRESS',
            amount: 2000,
            address: 'znhyGnfCgxd9NyUUDkEwTsBFc4dyYaogYJh',
            block_hash: block_hash,
            block_height : block_height
        }];

        TrezorConnect.signTx(inputs, outputs, function (response) {
             if (response.success) {
                 console.log('Serialized TX:', response.serialized_tx); // tx in hex
                 console.log('Signatures:', response.signatures); // array of signatures, in hex
             } else {
                 console.error('Error:', response.error); // error message
             }
             document.getElementById("response").innerHTML = JSON.stringify(response, undefined, 2);
        });
     }

    </script>
  </head>
  <body>

    <p>This example requires a device loaded with seed:</p>
    <pre>alcohol woman abuse must during monitor noble actual mixed trade anger aisle</pre>

    <button onclick="trezorSignTx(1)">Sign with key 1</button>
    <button onclick="trezorSignTx(2)">Sign with key 2</button>

    <pre id="response"></pre>

    <script src="../connect.js"></script>

  </body>
</html>
